<div class="silicon-gallery">
  <div class="stage-wrapper">
    <div class="display-unit">
      <div class="progress-track">
        <div class="progress-fill" id="timer-bar"></div>
      </div>
      
      <img id="main-image" src="" alt="Hardware View" />
      
      <div class="data-overlay">
        <div id="main-caption" class="simple-caption">INITIALIZING...</div>
        <div class="sys-info">ARCH: QARBYTE-CORE // STATUS: ACTIVE_TRACE</div>
      </div>
    </div>

    <div class="nav-cluster">
      <button class="node-btn" onclick="manualChange(-1)">_PREV</button>
      <div class="node-index"><span id="curr-num">01</span> / <span id="total-num">08</span></div>
      <button class="node-btn" onclick="manualChange(1)">_NEXT</button>
    </div>
  </div>

  <div class="wafer-grid">
    {% assign image_extensions = "jpg,jpeg,png,gif,webp" | split: "," %}
    {% for file in site.static_files %}
      {% if file.path contains 'static/highlights/' %}
        {% assign ext = file.extname | remove: '.' | downcase %}
        {% if image_extensions contains ext %}
          <div class="wafer-cell">
            <img class="wafer-thumb" 
                 src="{{ file.path | relative_url }}" 
                 alt="{{ file.name | split: '.' | first | replace: '_', ' ' | uppercase }}"
                 onclick="manualSelect(this, {{ forloop.index0 }})">
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
</div>

<script>
  const imageList = [];
  const altList = [];
  let currentIndex = 0;
  let scanTimer = null;
  const SCAN_DURATION = 5000;

  document.addEventListener('DOMContentLoaded', () => {
    const thumbs = document.querySelectorAll('.wafer-thumb');
    thumbs.forEach((img) => {
      imageList.push(img.src);
      altList.push(img.alt);
    });

    if(imageList.length > 0) {
      document.getElementById('total-num').textContent = imageList.length.toString().padStart(2, '0');
      updateDisplay(0);
      resetTimer();
    }
  });

  function updateDisplay(index) {
    currentIndex = index;
    const mainImg = document.getElementById('main-image');
    const caption = document.getElementById('main-caption');
    const indexDisplay = document.getElementById('curr-num');
    const thumbs = document.querySelectorAll('.wafer-thumb');

    // Smooth fade transition
    mainImg.style.opacity = '0';
    setTimeout(() => {
      mainImg.src = imageList[index];
      mainImg.onload = () => { mainImg.style.opacity = '1'; };
      caption.innerText = altList[index];
    }, 200);

    indexDisplay.textContent = (index + 1).toString().padStart(2, '0');
    thumbs.forEach((t, i) => {
      t.parentElement.classList.toggle('active', i === index);
    });
  }

  function resetTimer() {
    if (scanTimer) clearInterval(scanTimer);
    
    const bar = document.getElementById('timer-bar');
    bar.style.transition = 'none';
    bar.style.width = '0%';
    
    // Trigger reflow to restart animation
    setTimeout(() => {
      bar.style.transition = `width ${SCAN_DURATION}ms linear`;
      bar.style.width = '100%';
    }, 50);

    scanTimer = setInterval(() => {
      let nextIndex = (currentIndex + 1) % imageList.length;
      updateDisplay(nextIndex);
      resetTimer();
    }, SCAN_DURATION);
  }

  function manualSelect(el, index) {
    updateDisplay(index);
    resetTimer();
  }

  function manualChange(step) {
    let newIndex = (currentIndex + step + imageList.length) % imageList.length;
    updateDisplay(newIndex);
    resetTimer();
  }
</script>

<style>
  .silicon-gallery {
    display: flex; flex-direction: column; gap: 12px;
    background: #0f172a; padding: 15px; border-radius: 4px;
    border: 1px solid #1e293b; margin-bottom: 2rem;
  }

  .display-unit {
    position: relative; width: 100%; aspect-ratio: 16 / 9;
    background: #020617; overflow: hidden; border: 1px solid #1e293b;
  }

  #main-image {
    width: 100%; height: 100%; object-fit: contain;
    opacity: 0; transition: opacity 0.4s ease-in-out;
  }

  /* Smooth loading line at the top of the data overlay */
  .progress-track {
    position: absolute; bottom: 42px; /* Sits right on top of the overlay */
    left: 0; width: 100%; height: 1px;
    background: rgba(0, 255, 65, 0.05); z-index: 20;
  }

  .progress-fill {
    height: 100%; background: #00ff41; width: 0%;
    box-shadow: 0 0 8px #00ff41;
  }

  .data-overlay {
    position: absolute; bottom: 0; left: 0; width: 100%;
    padding: 8px 15px; background: rgba(2, 6, 23, 0.9);
    border-top: 1px solid #1e293b; z-index: 15;
  }

  .simple-caption {
    font-family: 'JetBrains Mono', monospace;
    color: #f8fafc; font-size: 0.75rem;
  }

  .sys-info {
    font-size: 0.5rem; color: #475569;
    font-family: 'JetBrains Mono', monospace; margin-top: 2px;
  }

  .wafer-grid {
    display: flex; gap: 8px; padding: 5px;
    background: #020617; overflow-x: auto;
  }

  .wafer-cell {
    width: 45px; height: 45px; flex-shrink: 0;
    border: 1px solid #1e293b; cursor: pointer;
  }

  .wafer-cell.active { border-color: #00ff41; }

  .wafer-thumb {
    width: 100%; height: 100%; object-fit: cover;
    opacity: 0.3; filter: grayscale(1); transition: 0.3s;
  }

  .wafer-cell.active .wafer-thumb { opacity: 1; filter: grayscale(0); }

  .nav-cluster {
    display: flex; justify-content: space-between; align-items: center;
    font-family: 'JetBrains Mono', monospace;
  }

  .node-btn {
    background: transparent; border: 1px solid #1e293b;
    color: #475569; padding: 4px 10px; font-size: 0.6rem; cursor: pointer;
  }

  .node-btn:hover { color: #00ff41; border-color: #00ff41; }
  .node-index { color: #00ff41; font-size: 0.75rem; opacity: 0.8; }
</style>
