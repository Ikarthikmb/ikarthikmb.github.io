---
layout: default
title: Code Viewer
---

<div class="viewer-controls">
  <button onclick="history.back()" class="btn btn-outline">
    ← Back
  </button>
  <a id="download-btn" download class="btn btn-primary" target="_blank" rel="noopener noreferrer">
    ⬇ Download Source
  </a>
</div>

<div class="file-info">
  <h1 id="file-title">Code Viewer</h1>
  <p id="file-link"></p>
</div>

<div id="markdown-container" class="markdown-body" style="display:none;"></div>

<div id="code-wrapper" class="code-window">
  <div class="window-header">
    <div class="dots"><span class="r"></span><span class="y"></span><span class="g"></span></div>
    <div id="window-filename" class="window-title">code_viewer.v</div>
  </div>
  <pre id="code-block" class="line-numbers">
    <code id="code-content">/* Initializing hardware registers... */</code>
  </pre>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-tomorrow.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/plugins/line-numbers/prism-line-numbers.css" />
<script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  // Map common extensions to Prism language classes
  const extensionToLang = {
    'py': 'python',
    'js': 'javascript',
    'ts': 'typescript',
    'java': 'java',
    'c': 'c',
    'cpp': 'cpp',
    'h': 'cpp',
    'hpp': 'cpp',
    'cs': 'csharp',
    'rb': 'ruby',
    'go': 'go',
    'php': 'php',
    'html': 'markup',
    'xml': 'markup',
    'json': 'json',
    'md': 'markdown',
    'markdown': 'markdown',
    'sh': 'bash',
    'verilog': 'verilog',
    'v': 'verilog',
    'sv': 'systemverilog',
    'vh': 'verilog',
    'ino': 'cpp',
    'm': 'matlab'
  };

  async function loadPrismLang(lang) {
    if (!Prism.languages[lang]) {
      try {
        const script = document.createElement('script');
        script.src = `https://cdn.jsdelivr.net/npm/prismjs/components/prism-${lang}.min.js`;
        document.head.appendChild(script);
        return new Promise(resolve => script.onload = resolve);
      } catch (e) { console.error("Lang load failed", e); }
    }
  }

  window.addEventListener('load', async function () {
    const params = new URLSearchParams(window.location.search);
    let fileUrl = params.get('file');
    const originalFileUrl = fileUrl;
    const codeBlock = document.getElementById('code-block');
    const codeEl = document.getElementById('code-content');
    const markdownEl = document.getElementById('markdown-container');
    const titleEl = document.getElementById('file-title');
    const windowTitle = document.getElementById('window-filename');
    const linkEl = document.getElementById('file-link');
    const downloadBtn = document.getElementById('download-btn');

    if (!fileUrl) {
      codeEl.textContent = '// ERROR: No source file specified in URL';
      return;
    }

    if (fileUrl.includes('github.com')) {
      fileUrl = fileUrl.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
    }

    const fileName = fileUrl.split('/').pop();
    titleEl.textContent = fileName;
    windowTitle.textContent = fileName;
    linkEl.innerHTML = `Source: <a href="${originalFileUrl}" target="_blank">${originalFileUrl}</a>`;
    downloadBtn.href = fileUrl;

    const ext = fileName.split('.').pop().toLowerCase();
    const isMarkdown = ext === 'md' || ext === 'markdown';

    if (!isMarkdown) {
      const lang = extensionToLang[ext] || 'none';
      codeEl.className = `language-${lang}`;
      codeBlock.className = `line-numbers language-${lang}`;
      if (lang !== 'none') await loadPrismLang(lang);
    }

    fetch(fileUrl)
      .then(response => {
        if (!response.ok) throw new Error('HTTP ' + response.status);
        return response.text();
      })
      .then(data => {
        if (isMarkdown) {
          markdownEl.innerHTML = marked.parse(data);
          markdownEl.style.display = 'block';
          document.getElementById('code-wrapper').style.display = 'none';
        } else {
          codeEl.textContent = data;
          Prism.highlightElement(codeEl);
        }
      })
      .catch(error => {
        codeEl.textContent = `// Failed to fetch source: ${error.message}`;
      });
  });
</script>

<style>
  /* Base Theme - Slate & Green */
  body {
    background-color: #020617; /* Slate 950 */
    color: #e2e8f0;
    font-family: 'Inter', -apple-system, sans-serif;
    padding: 2rem 1rem;
    max-width: 1000px;
    margin: auto;
  }

  .viewer-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .btn {
    padding: 8px 18px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
  }

  .btn-outline {
    background: transparent;
    border: 1px solid #334155;
    color: #94a3b8;
  }

  .btn-outline:hover {
    border-color: #22c55e;
    color: #22c55e;
  }

  .btn-primary {
    background: #22c55e; /* Dev Green */
    color: #020617;
    border: none;
  }

  .btn-primary:hover {
    background: #4ade80;
    box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
  }

  .file-info h1 {
    font-size: 1.8rem;
    color: #f8fafc;
    margin: 0;
  }

  #file-link {
    font-family: 'Fira Code', monospace;
    font-size: 0.8rem;
    color: #64748b;
    margin-bottom: 2rem;
  }

  #file-link a { color: #22c55e; text-decoration: none; }

  /* The Terminal / Code Window Styling */
  .code-window {
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  }

  .window-header {
    background: #1e293b;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #334155;
  }

  .dots {
    display: flex;
    gap: 8px;
  }

  .dots span { width: 12px; height: 12px; border-radius: 50%; }
  .r { background: #ff5f56; }
  .y { background: #ffbd2e; }
  .g { background: #27c93f; }

  .window-title {
    margin-left: 20px;
    font-family: 'Fira Code', monospace;
    font-size: 0.75rem;
    color: #94a3b8;
  }

  /* Prism Customization */
  pre[class*="language-"] {
    background: #0f172a !important;
    margin: 0 !important;
    padding: 1.5rem !important;
    font-family: 'Fira Code', monospace !important;
    font-size: 0.9rem !important;
    line-height: 1.6;
  }

  .line-numbers .line-numbers-rows {
    border-right: 1px solid #1e293b !important;
    background: #0f172a !important;
  }

  /* Markdown Body Styling */
  .markdown-body {
    background: #0f172a;
    padding: 2rem;
    border-radius: 12px;
    border: 1px solid #1e293b;
    line-height: 1.7;
  }

  .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #1e293b; padding-bottom: 0.3rem; }
  .markdown-body code { background: #334155; padding: 2px 5px; border-radius: 4px; }
</style>
